{% extends 'judging/base.html' %}
{% load custom_filters %}

{% block title %}Оцінювання {{ team.name }} - Сервіс Оцінювання{% endblock %}

{% block content %}
<h1 class="mb-4">Оцінювання команди: {{ team.name }}</h1>

<div class="card mb-4">
    <div class="card-header">
        <h3>Інформація про команду</h3>
    </div>
    <div class="card-body">
        <h4>{{ team.name }}</h4>
        <p>{{ team.members }}</p>

        {% if is_admin %}
        <!-- Service selection form for admins -->
        <div class="mt-4">
            <h5>Вибір сервісу (технологічного вектору)</h5>
            <form method="post" class="mt-3">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ service_form.service.id_for_label }}">Сервіс:</label>
                            {{ service_form.service }}
                        </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" name="save_service" class="btn btn-primary">Зберегти сервіс</button>
                    </div>
                </div>
            </form>
        </div>
        {% else %}
        <!-- Display selected service for jury -->
        {% if team.service %}
        <div class="mt-3">
            <h5>Технологічний вектор команди:</h5>
            <p class="lead">{{ team.get_service_display }}</p>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Форма оцінювання</h3>
    </div>
    <div class="card-body">
        <form method="post" id="score-form">
            {% csrf_token %}

            <div class="alert alert-info">
                <p>Оцініть кожен критерій за шкалою від 0 до максимального балу. Загальний бал буде розрахований як середнє арифметичне оцінок усіх суддів.</p>
            </div>

            <!-- All criteria in a single list -->
            <div class="criteria-section mb-4">
                <h4>Критерії оцінювання</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="width: 20%">Критерій</th>
                                <th style="width: 55%">Опис</th>
                                <th style="width: 15%">Макс. бали</th>
                                <th style="width: 10%">Ваша оцінка</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Main criteria -->
                            {% for criteria in main_criteria %}
                            <tr>
                                <td>{{ criteria.name }}</td>
                                <td>{{ criteria.description }}</td>
                                <td>{{ criteria.max_score }}</td>
                                <td class="text-center">
                                    <input 
                                        type="number" 
                                        name="criteria_{{ criteria.id }}" 
                                        class="form-control criteria-input" 
                                        data-max-score="{{ criteria.max_score }}"
                                        min="0" 
                                        max="{{ criteria.max_score }}" 
                                        step="1" 
                                        value="{{ existing_scores|get_item:criteria.id|default:0 }}"
                                    >
                                </td>
                            </tr>
                            {% endfor %}

                            <!-- Bonus criteria -->
                            {% if bonus_criteria %}
                            {% for criteria in bonus_criteria %}
                            <tr>
                                <td>{{ criteria.name }}</td>
                                <td>{{ criteria.description }}</td>
                                <td>{{ criteria.max_score }}</td>
                                <td class="text-center">
                                    <input 
                                        type="number" 
                                        name="criteria_{{ criteria.id }}" 
                                        class="form-control criteria-input bonus-input" 
                                        data-max-score="{{ criteria.max_score }}"
                                        min="0" 
                                        max="{{ criteria.max_score }}" 
                                        step="1" 
                                        value="{{ existing_scores|get_item:criteria.id|default:0 }}"
                                    >
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>

<!--                <div class="alert alert-success">-->
<!--                    <strong>Загальна сума балів за основні критерії: <span id="main-total">0</span></strong>-->
<!--                </div>-->

<!--                {% if bonus_criteria %}-->
<!--                <div class="alert alert-success">-->
<!--                    <strong>Загальна сума балів за додаткові критерії: <span id="bonus-total">0</span></strong>-->
<!--                </div>-->
                {% endif %}
            </div>

<!--            <div class="alert alert-primary">-->
<!--                <h4>Загальна сума балів: <span id="grand-total">{{ result.total_score|floatformat:1 }}</span></h4>-->
<!--            </div>-->

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'team_list' %}" class="btn btn-secondary me-md-2">Скасувати</a>
                <button type="submit" name="save_scores" class="btn btn-primary">Відправити оцінки</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.criteria-input');
        const mainTotalElement = document.getElementById('main-total');
        const bonusTotalElement = document.getElementById('bonus-total');
        const grandTotalElement = document.getElementById('grand-total');

        // Function to calculate and update totals
        function updateTotals() {
            let mainTotal = 0;
            let bonusTotal = 0;

            // Calculate main criteria total
            document.querySelectorAll('.criteria-input:not(.bonus-input)').forEach(function(input) {
                const value = parseFloat(input.value) || 0;
                mainTotal += value;
            });

            // Calculate bonus criteria total
            document.querySelectorAll('.bonus-input').forEach(function(input) {
                const value = parseFloat(input.value) || 0;
                bonusTotal += value;
            });

            // Update the display
            mainTotalElement.textContent = mainTotal.toFixed(1);
            if (bonusTotalElement) {
                bonusTotalElement.textContent = bonusTotal.toFixed(1);
            }
            grandTotalElement.textContent = (mainTotal + bonusTotal).toFixed(1);
        }

        // Add event listeners to all inputs
        inputs.forEach(function(input) {
            input.addEventListener('input', updateTotals);

            // Add validation to ensure input doesn't exceed max score
            input.addEventListener('change', function() {
                const maxScore = parseFloat(this.dataset.maxScore);
                let value = parseFloat(this.value) || 0;

                // Ensure value is within valid range
                if (value < 0) value = 0;
                if (value > maxScore) value = maxScore;

                this.value = value;
                updateTotals();
            });
        });

        // Initial calculation
        updateTotals();
    });
</script>
{% endblock %}
